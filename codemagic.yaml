workflows:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # iOS BUILD FOR APP STORE CONNECT (PRIMARY)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ios-capacitor-testflight:
    name: iOS â€¢ Capacitor -> TestFlight
    instance_type: mac_mini_m2
    max_build_duration: 75
    environment:
      groups:
        - ios_config
        - appstore_credentials
      ios_signing:
        distribution_type: app_store
        bundle_identifier: $BUNDLE_ID
      node: 20.11.1
      npm: 10
      xcode: latest
      cocoapods: default
    cache:
      cache_paths:
        - ~/.npm
        - ~/.cocoapods
        - ios/Pods
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Quality gates
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Playwright smoke
        script: |
          npx playwright install --with-deps chromium
          npm run test:e2e:smoke
      - name: Build archive & IPA
        script: |
          chmod +x scripts/build-ios.sh
          scripts/build-ios.sh
      - name: ğŸ”¬ Root Cause Diagnostics
        script: |
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DIAGNOSTIC 1: Environment Versions"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ruby version:"
          ruby --version
          echo ""
          echo "Fastlane version:"
          bundle exec fastlane --version 2>/dev/null || fastlane --version
          echo ""
          echo "OpenSSL version:"
          openssl version
          echo ""
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "System time (UTC):"
          date -u '+%Y-%m-%d %H:%M:%S %Z'
          echo ""
          echo "System time (Local):"
          date '+%Y-%m-%d %H:%M:%S %Z'
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DIAGNOSTIC 2: Key File Analysis"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Decode key
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" | base64 -d > /tmp/diagnostic_key.p8
          chmod 600 /tmp/diagnostic_key.p8
          
          echo "Key file size: $(wc -c < /tmp/diagnostic_key.p8) bytes"
          echo "Key file lines: $(wc -l < /tmp/diagnostic_key.p8)"
          echo ""
          echo "First line:"
          head -1 /tmp/diagnostic_key.p8
          echo ""
          echo "Last line:"
          tail -1 /tmp/diagnostic_key.p8
          echo ""
          echo "Base64 content preview (line 2, first 60 chars):"
          sed -n '2p' /tmp/diagnostic_key.p8 | head -c 60
          echo ""
          echo ""
          echo "MD5 hash:"
          md5sum /tmp/diagnostic_key.p8 | awk '{print $1}'
          echo ""
          echo "OpenSSL key validation:"
          if openssl ec -in /tmp/diagnostic_key.p8 -check -noout 2>&1 | grep -q "ok"; then
            echo "âœ… Key is cryptographically valid"
          else
            echo "âŒ Key validation failed:"
            openssl ec -in /tmp/diagnostic_key.p8 -check -noout 2>&1
          fi
          echo ""
          echo "OpenSSL key info (first 15 lines):"
          openssl ec -in /tmp/diagnostic_key.p8 -text -noout 2>&1 | head -15
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DIAGNOSTIC 3: Fastlane JWT Generation Test"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Test if Fastlane can create JWT from the key
          cat > /tmp/jwt_test.rb <<'EOF'
require 'spaceship'

begin
  puts "Attempting to create JWT with Spaceship library..."
  
  api_key = Spaceship::ConnectAPI::Token.create(
    key_id: "5XDRL75994",
    issuer_id: "7efaf094-3c6f-4c6c-afdb-d6e2c84871c7",
    filepath: "/tmp/diagnostic_key.p8"
  )
  
  puts "âœ… JWT CREATION: SUCCESS"
  puts "Token type: #{api_key.class}"
  puts "Token length: #{api_key.text.length} characters"
  puts "Token preview: #{api_key.text[0..50]}..."
  puts ""
  puts "This means: The key is valid and JWT generation works!"
  puts "Root cause is likely in upload_to_testflight parameters or network."
  
rescue OpenSSL::PKey::ECError => e
  puts "âŒ JWT CREATION: FAILED (OpenSSL Error)"
  puts "Error: #{e.class} - #{e.message}"
  puts ""
  puts "This means: The key format is incompatible with OpenSSL/JWT library."
  puts "Root cause: Key encoding or OpenSSL version mismatch."
  puts ""
  puts "Backtrace:"
  puts e.backtrace[0..3].join("\n")
  
rescue JWT::DecodeError => e
  puts "âŒ JWT CREATION: FAILED (JWT Decode Error)"
  puts "Error: #{e.class} - #{e.message}"
  puts ""
  puts "This means: JWT library cannot parse the key."
  puts "Root cause: JWT gem version or algorithm incompatibility."
  
rescue => e
  puts "âŒ JWT CREATION: FAILED (Unknown Error)"
  puts "Error: #{e.class} - #{e.message}"
  puts ""
  puts "Backtrace:"
  puts e.backtrace[0..5].join("\n")
end
EOF
          
          bundle config set path 'vendor/bundle'
          bundle install
          bundle exec ruby /tmp/jwt_test.rb
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DIAGNOSTIC 4: Version History Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "Current Fastlane version (from Gemfile.lock):"
          grep -A2 "  fastlane (" Gemfile.lock || echo "Not found in Gemfile.lock"
          
          echo ""
          echo "Current JWT gem version:"
          grep -A2 "  jwt (" Gemfile.lock || echo "Not found in Gemfile.lock"
          
          echo ""
          echo "All Ruby gems with 'jwt' or 'token':"
          grep -i "jwt\|token" Gemfile.lock | head -10 || echo "None found"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DIAGNOSTIC 5: Network & Time Sync"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "Can reach Apple API:"
          curl -I https://api.appstoreconnect.apple.com 2>&1 | head -2 || echo "Failed"
          
          echo ""
          echo "Time server check (NTP):"
          sntp -d pool.ntp.org 2>&1 | grep -i "offset" | head -1 || echo "Could not check NTP"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š DIAGNOSTIC SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Next steps:"
          echo "1. Review the output above"
          echo "2. Look for the JWT test result: SUCCESS or FAILED"
          echo "3. If SUCCESS: problem is in upload parameters"
          echo "4. If FAILED: note the error type for targeted fix"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Cleanup
          rm -f /tmp/diagnostic_key.p8 /tmp/jwt_test.rb
      - name: Upload to TestFlight
        script: |
          bundle config set path 'vendor/bundle'
          bundle install
          cd ios
          BUNDLE_GEMFILE=../Gemfile BUNDLE_PATH=../vendor/bundle bundle exec fastlane ios upload
      - name: Verify artifacts
        script: bash scripts/verify-codemagic.sh
    artifacts:
      - ios/build/export/*.ipa
      - ios/build/TradeLine247.xcarchive
      - playwright-report/**/*
      - dist/**/*
      - build-artifacts-sha256.txt
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ANDROID BUILD (OPTIONAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android-capacitor-release:
    name: Android â€¢ Capacitor bundleRelease
    instance_type: linux_x2
    max_build_duration: 60
    environment:
      groups:
        - android_signing
      node: 20.11.1
      npm: 10
      java: 17
    cache:
      cache_paths:
        - ~/.npm
        - ~/.gradle
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Quality gates
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Playwright smoke
        script: |
          npx playwright install --with-deps chromium
          npm run test:e2e:smoke
      - name: Build Android App Bundle
        script: bash scripts/build-android.sh
      - name: Verify artifacts
        script: bash scripts/verify-codemagic.sh
    artifacts:
      - android/app/build/outputs/**/*.aab
      - playwright-report/**/*
      - dist/**/*
      - build-artifacts-sha256.txt

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # WEB TESTS (LINUX) - CI VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-tests-only:
    name: Web Tests & Smoke
    instance_type: linux
    max_build_duration: 45
    environment:
      node: 20.11.1
      npm: 10
    cache:
      cache_paths:
        - ~/.npm
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Lint, typecheck, unit tests
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Build web bundle
        script: npm run build:web
      - name: Install Playwright browsers
        script: npm run test:install-browsers
      - name: Run full Playwright test suite
        script: npx playwright test --reporter=html
    artifacts:
      - playwright-report/**/*
      - dist/**/*
