workflows:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # iOS BUILD FOR APP STORE CONNECT (PRIMARY)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ios-capacitor-testflight:
    name: iOS â€¢ Capacitor -> TestFlight
    instance_type: mac_mini_m2
    max_build_duration: 75
    environment:
      groups:
        - ios_config
        - appstore_credentials
      ios_signing:
        distribution_type: app_store
        bundle_identifier: $BUNDLE_ID
      node: 20.11.1
      npm: 10
      xcode: latest
      cocoapods: default
    cache:
      cache_paths:
        - ~/.npm
        - ~/.cocoapods
        - ios/Pods
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Quality gates
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Playwright smoke
        script: |
          npx playwright install --with-deps chromium
          npm run test:e2e:smoke
      - name: Build archive & IPA
        script: |
          chmod +x scripts/build-ios.sh
          scripts/build-ios.sh
      - name: Upload to TestFlight
        script: |
          # ============================================================================
          # Enterprise-Grade TestFlight Upload with xcrun altool
          # ============================================================================

          set -euo pipefail

          echo "ğŸš€ Starting Enterprise TestFlight Upload..."
          echo "ğŸ“… $(date)"
          echo "ğŸ—ï¸  Build: $CM_BUILD_ID"

          # ============================================================================
          # PHASE 1: Pre-Flight Validation
          # ============================================================================

          echo ""
          echo "ğŸ“‹ PHASE 1: Pre-flight validation..."

          # Validate required environment variables
          : "${APP_STORE_CONNECT_KEY_IDENTIFIER:?"ERROR: APP_STORE_CONNECT_KEY_IDENTIFIER not set"}"
          : "${APP_STORE_CONNECT_ISSUER_ID:?"ERROR: APP_STORE_CONNECT_ISSUER_ID not set"}"
          : "${APP_STORE_CONNECT_PRIVATE_KEY:?"ERROR: APP_STORE_CONNECT_PRIVATE_KEY not set"}"
          : "${APP_STORE_ID:?"ERROR: APP_STORE_CONNECT_APP_ID not set"}"
          : "${BUNDLE_ID:?"ERROR: BUNDLE_ID not set"}"

          echo "âœ… Environment variables validated"

          # Validate required tools
          if ! command -v xcrun >/dev/null 2>&1; then
            echo "âŒ ERROR: xcrun not found"
            exit 1
          fi

          if ! command -v jq >/dev/null 2>&1; then
            echo "âŒ ERROR: jq not found - install with: brew install jq"
            exit 1
          fi

          echo "âœ… Required tools available"

          # Validate IPA file exists and is readable
          IPA_PATH_FILE="ios/build/export/ipa_path.txt"
          if [[ ! -f "$IPA_PATH_FILE" ]]; then
            echo "âŒ ERROR: IPA path file not found: $IPA_PATH_FILE"
            exit 1
          fi

          IPA_PATH=$(cat "$IPA_PATH_FILE")
          if [[ ! -f "$IPA_PATH" ]]; then
            echo "âŒ ERROR: IPA file not found: $IPA_PATH"
            exit 1
          fi

          IPA_SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH" 2>/dev/null || echo "0")
          if [[ "$IPA_SIZE" -lt 10000000 ]]; then
            echo "âŒ ERROR: IPA file too small (${IPA_SIZE} bytes) - likely corrupted"
            exit 1
          fi

          echo "âœ… IPA validated: $IPA_PATH (${IPA_SIZE} bytes)"

          # ============================================================================
          # PHASE 2: API Key File Creation
          # ============================================================================

          echo ""
          echo "ğŸ” PHASE 2: Creating API key file..."

          # Create temporary directory for API key
          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT

          API_KEY_PATH="$TEMP_DIR/AuthKey_$APP_STORE_CONNECT_KEY_IDENTIFIER.p8"

          # Decode and create API key file
          if [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == "-----BEGIN PRIVATE KEY-----"* ]]; then
            # Already in PEM format
            echo "$APP_STORE_CONNECT_PRIVATE_KEY" > "$API_KEY_PATH"
          else
            # Base64 encoded
            echo "$APP_STORE_CONNECT_PRIVATE_KEY" | base64 -d > "$API_KEY_PATH" 2>/dev/null || \
            echo "$APP_STORE_CONNECT_PRIVATE_KEY" | base64 --decode > "$API_KEY_PATH" 2>/dev/null || {
              echo "âŒ ERROR: Failed to decode API key"
              exit 1
            }
          fi

          # Validate API key file
          if [[ ! -f "$API_KEY_PATH" ]]; then
            echo "âŒ ERROR: API key file not created"
            exit 1
          fi

          if [[ ! -s "$API_KEY_PATH" ]]; then
            echo "âŒ ERROR: API key file is empty"
            exit 1
          fi

          # Set secure permissions
          chmod 600 "$API_KEY_PATH"

          echo "âœ… API key file created and validated"

          # ============================================================================
          # PHASE 3: TestFlight Upload with Retry Logic
          # ============================================================================

          echo ""
          echo "ğŸ“¤ PHASE 3: Uploading to TestFlight..."

          MAX_RETRIES=3
          RETRY_DELAY=30

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "ğŸ”„ Upload attempt $attempt/$MAX_RETRIES"

            # Perform upload
            UPLOAD_START=$(date +%s)

            if xcrun altool --upload-app \
              --type ios \
              --file "$IPA_PATH" \
              --apiKey "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
              --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
              --set-app-test-information "{\"whats_new\":\"Automated build $CM_BUILD_ID\"}" \
              --verbose \
              --output-format json > upload_result.json 2>&1; then

              UPLOAD_END=$(date +%s)
              UPLOAD_DURATION=$((UPLOAD_END - UPLOAD_START))

              echo "âœ… Upload successful (took ${UPLOAD_DURATION}s)"

              # Parse and validate result
              if [[ -f "upload_result.json" ]] && jq -e '.success' upload_result.json >/dev/null 2>&1; then
                echo "ğŸ‰ TestFlight upload completed successfully!"
                echo "ğŸ“Š Upload duration: ${UPLOAD_DURATION} seconds"
                break
              else
                echo "âš ï¸  Upload command succeeded but result validation failed"
                cat upload_result.json 2>/dev/null || echo "No result file found"
              fi

            else
              UPLOAD_END=$(date +%s)
              UPLOAD_DURATION=$((UPLOAD_END - UPLOAD_START))

              echo "âŒ Upload attempt $attempt failed (took ${UPLOAD_DURATION}s)"

              # Analyze error
              if [[ -f "upload_result.json" ]]; then
                ERROR_CODE=$(jq -r '.["product-errors"] // empty | .[0]["code"] // "unknown"' upload_result.json 2>/dev/null || echo "unknown")
                ERROR_MESSAGE=$(jq -r '.["product-errors"] // empty | .[0]["message"] // "unknown"' upload_result.json 2>/dev/null || echo "unknown")

                echo "ğŸ” Error analysis:"
                echo "   Code: $ERROR_CODE"
                echo "   Message: $ERROR_MESSAGE"

                # Handle specific error codes
                case "$ERROR_CODE" in
                  "ITC.HTTP.INTERNAL_ERROR"|"ITC.HTTP.CONNECTION_ERROR")
                    echo "ğŸŒ Network/server error - will retry"
                    ;;
                  "ITC.API.INVALID_PARAMETER")
                    echo "âŒ Invalid parameters - will not retry"
                    exit 1
                    ;;
                  "ITC.API.APP_NOT_FOUND")
                    echo "âŒ App not found - check APP_STORE_ID and BUNDLE_ID"
                    exit 1
                    ;;
                  "ITC.API.UNAUTHORIZED")
                    echo "âŒ Authentication failed - check API credentials"
                    exit 1
                    ;;
                  "ITC.API.TOO_MANY_REQUESTS")
                    echo "â³ Rate limited - will retry with longer delay"
                    RETRY_DELAY=60
                    ;;
                  *)
                    echo "âš ï¸  Unknown error - will retry"
                    ;;
                esac

                # Show full error details for debugging
                echo "ğŸ“‹ Full error details:"
                cat upload_result.json
              else
                echo "ğŸ“‹ Raw error output:"
                cat upload_result.json 2>/dev/null || echo "No error output captured"
              fi

              # Don't retry on last attempt
              if [[ $attempt -eq $MAX_RETRIES ]]; then
                echo "ğŸ’¥ All upload attempts failed"
                exit 1
              fi

              echo "â³ Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done

          # ============================================================================
          # PHASE 4: Post-Upload Validation
          # ============================================================================

          echo ""
          echo "ğŸ” PHASE 4: Post-upload validation..."

          # Check if upload was actually successful by querying app status
          echo "ğŸ“Š Validating upload completion..."

          if xcrun altool --app-info \
            --apiKey "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --output-format json > app_info.json 2>&1; then

            if [[ -f "app_info.json" ]] && jq -e '.[].versions | length > 0' app_info.json >/dev/null 2>&1; then
              VERSION_COUNT=$(jq '.[].versions | length' app_info.json)
              echo "âœ… App validation successful - $VERSION_COUNT version(s) found"
            else
              echo "âš ï¸  App info retrieved but version validation inconclusive"
            fi
          else
            echo "âš ï¸  Could not validate app info - upload may still be processing"
          fi

          # ============================================================================
          # PHASE 5: Cleanup
          # ============================================================================

          echo ""
          echo "ğŸ§¹ PHASE 5: Cleanup..."

          # Remove temporary files
          rm -rf "$TEMP_DIR"
          rm -f upload_result.json app_info.json

          echo "âœ… Sensitive files cleaned up"
          echo "âœ… Enterprise TestFlight upload complete"

          echo ""
          echo "=============================================="
          echo "ğŸ¯ MISSION ACCOMPLISHED"
          echo "=============================================="
          echo "âœ… Pre-flight validation complete"
          echo "âœ… API key file created and secured"
          echo "âœ… TestFlight upload successful"
          echo "âœ… Error handling and retries functional"
          echo "âœ… Cleanup completed"
          echo "=============================================="
          echo ""
          echo "ğŸš€ Build $CM_BUILD_ID ready for testing in TestFlight!"
      - name: Verify artifacts
        script: bash scripts/verify-codemagic.sh
    artifacts:
      - ios/build/export/*.ipa
      - ios/build/TradeLine247.xcarchive
      - playwright-report/**/*
      - dist/**/*
      - build-artifacts-sha256.txt
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ANDROID BUILD (OPTIONAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android-capacitor-release:
    name: Android â€¢ Capacitor bundleRelease
    instance_type: linux_x2
    max_build_duration: 60
    environment:
      groups:
        - android_signing
      node: 20.11.1
      npm: 10
      java: 17
    cache:
      cache_paths:
        - ~/.npm
        - ~/.gradle
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Quality gates
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Playwright smoke
        script: |
          npx playwright install --with-deps chromium
          npm run test:e2e:smoke
      - name: Build Android App Bundle
        script: bash scripts/build-android.sh
      - name: Verify artifacts
        script: bash scripts/verify-codemagic.sh
    artifacts:
      - android/app/build/outputs/**/*.aab
      - playwright-report/**/*
      - dist/**/*
      - build-artifacts-sha256.txt

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # WEB TESTS (LINUX) - CI VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-tests-only:
    name: Web Tests & Smoke
    instance_type: linux
    max_build_duration: 45
    environment:
      node: 20.11.1
      npm: 10
    cache:
      cache_paths:
        - ~/.npm
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Lint, typecheck, unit tests
        script: npm run lint && npm run typecheck && npm run test:unit
      - name: Build web bundle
        script: npm run build:web
      - name: Install Playwright browsers
        script: npm run test:install-browsers
      - name: Run full Playwright test suite
        script: npx playwright test --reporter=html
    artifacts:
      - playwright-report/**/*
      - dist/**/*
