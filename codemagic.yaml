# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRADELINE 24/7 â€” iOS Build Pipeline
# GOODBUILD Baseline: Build #77 (Oct 27, 2025) - Commit d075d9b
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

workflows:
  ios-capacitor-testflight:
    name: iOS â€¢ Capacitor -> TestFlight
    instance_type: mac_mini_m2
    max_build_duration: 75

    environment:
      groups:
        - ios_config
        - appstore_credentials

      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.apex.tradeline

      vars:
        XCODE_SCHEME: App
        XCODE_WORKSPACE: ios/App/App.xcworkspace
        BUNDLE_ID: com.apex.tradeline
        TEAM_ID: NWGUYF42KW
        APP_VERSION: "1.0.2"

      node: 20.11.1
      npm: 10
      xcode: 16.4
      cocoapods: default

    cache:
      cache_paths:
        - ~/.npm
        - ~/.cocoapods
        - ios/Pods

    scripts:
      - name: Install dependencies
        script: |
          set -euo pipefail
          npm ci

      - name: Build web assets
        script: |
          set -euo pipefail
          npm run build

      - name: Sync Capacitor for iOS
        script: |
          set -euo pipefail
          npx cap sync ios

      - name: Install CocoaPods
        script: |
          set -euo pipefail
          cd ios/App
          pod install --repo-update

      - name: Set iOS version & build number
        script: |
          set -eo pipefail
          bash ./scripts/set-ios-version-from-codemagic.sh

      - name: Set up code signing
        script: |
          set -euo pipefail
          echo "[signing] Applying provisioning profiles..."
          xcode-project use-profiles
          echo "âœ… Code signing configured"

      - name: Build archive & IPA
        script: |
          set -euo pipefail

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¨ BUILDING iOS ARCHIVE & IPA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Workspace: ${XCODE_WORKSPACE}"
          echo "Scheme:    ${XCODE_SCHEME}"
          echo "Bundle ID: ${BUNDLE_ID}"
          echo "Team ID:   ${TEAM_ID}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          xcode-project build-ipa \
            --workspace "${CM_BUILD_DIR}/${XCODE_WORKSPACE}" \
            --scheme "${XCODE_SCHEME}" \
            --config Release \
            --archive-directory "${CM_BUILD_DIR}/build/ios/archive" \
            --ipa-directory "${CM_BUILD_DIR}/build/ios/ipa"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… iOS ARCHIVE & IPA SUCCESSFULLY BUILT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ls -la "${CM_BUILD_DIR}/build/ios/ipa/"

      - name: Publish to TestFlight
        script: |
          set -euo pipefail

          echo "[publish] Finding IPA..."
          IPA_PATH=$(find "${CM_BUILD_DIR}/build/ios/ipa" -name "*.ipa" | head -1)

          if [ -z "${IPA_PATH}" ]; then
            echo "âŒ ERROR: No IPA file found"
            exit 1
          fi

          echo "[publish] Uploading ${IPA_PATH} to TestFlight..."
          app-store-connect publish \
            --path "${IPA_PATH}" \
            --testflight

          echo "âœ… Successfully uploaded to TestFlight"

    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive
      - /tmp/xcodebuild_logs/*.log
