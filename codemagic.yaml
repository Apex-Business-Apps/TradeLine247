workflows:

  ios-capacitor-testflight:

    name: TradeLine 24/7 iOS TestFlight
    max_build_duration: 60
    instance_type: mac_mini_m2


    environment:
      groups:
        - ios_config
        - appstore_credentials
      vars:
        XCODE_WORKSPACE: ios/App/App.xcworkspace
        XCODE_SCHEME: App
        BUNDLE_ID: com.apex.tradeline
      xcode: 16.4
      node: 20.11.1
      npm: 10
      cocoapods: default


      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.apex.tradeline


    cache:
      cache_paths:
        - ~/.npm
        - ~/.cocoapods
        - ios/Pods


    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true


    scripts:
      - name: Install Node dependencies
        script: |
          set -eo pipefail
          npm ci


      - name: Build web assets
        script: |
          set -eo pipefail
          npm run build


      - name: Sync Capacitor iOS
        script: |
          set -eo pipefail
          npx cap sync ios


      - name: Install CocoaPods
        script: |
          set -eo pipefail
          cd ios/App && pod install --repo-update


      - name: Configure code signing
        script: |
          set -eo pipefail
          xcode-project use-profiles \
            --custom-export-options='{"testFlightInternalTestingOnly": true}'


      - name: Build archive and IPA
        script: |
          set -eo pipefail
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¨ Building iOS Archive"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Workspace: $XCODE_WORKSPACE"
          echo "Scheme:    $XCODE_SCHEME"
          echo "Config:    Release"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME" \
            --config Release \
            --archive-flags="-destination 'generic/platform=iOS'"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… iOS Archive & IPA Successfully Built"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"


    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app


    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ANDROID BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android-capacitor-release:

    name: TradeLine 24/7 Android Release
    instance_type: linux_x2
    max_build_duration: 60


    environment:
      groups:
        - android_signing
      node: 20.11.1
      npm: 10
      java: 17
      vars:
        ANDROID_BUILD_TYPE: bundleRelease


    cache:
      cache_paths:
        - ~/.npm
        - ~/.gradle
        - android/.gradle


    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true


    scripts:
      - name: Install Node dependencies
        script: |
          set -eo pipefail
          npm ci


      - name: Build web assets
        script: |
          set -eo pipefail
          npm run build


      - name: Sync Capacitor Android
        script: |
          set -eo pipefail
          npx cap sync android


      - name: Build Android App Bundle
        script: |
          set -eo pipefail
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– Building Android App Bundle (AAB)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          cd android
          
          # Set up keystore from environment
          if [ -n "$CM_KEYSTORE" ]; then
            echo "$CM_KEYSTORE" | base64 --decode > keystore.jks
            echo "storeFile=keystore.jks" >> key.properties
            echo "storePassword=$CM_KEYSTORE_PASSWORD" >> key.properties
            echo "keyAlias=$CM_KEY_ALIAS" >> key.properties
            echo "keyPassword=$CM_KEY_PASSWORD" >> key.properties
          fi
          
          # Build release AAB
          ./gradlew bundleRelease \
            --no-daemon \
            --warning-mode all \
            -Pandroid.injected.signing.store.file=keystore.jks \
            -Pandroid.injected.signing.store.password="$CM_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$CM_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$CM_KEY_PASSWORD"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Android AAB Successfully Built"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ls -la app/build/outputs/bundle/release/


    artifacts:
      - android/app/build/outputs/**/*.aab
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**/*


    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true