# fastlane/Fastfile
# =============================================================================
# TradeLine 24/7 - Fastlane Configuration for Codemagic CI
# =============================================================================
# This Fastfile provides deterministic TestFlight uploads using App Store
# Connect API credentials provided via Codemagic environment variables.
# =============================================================================

default_platform(:ios)

def normalize_private_key(key_content)
  # If the env value contains literal \n sequences (single-line encoded key),
  # convert them back to real newlines. If the key already includes real newlines
  # and the -----BEGIN PRIVATE KEY----- header, leave it unchanged.
  if key_content.include?("\\n") && !key_content.include?("\n")
    key_content.gsub("\\n", "\n")
  else
    key_content
  end
end

def tradeline_app_store_api_key
  # Use APP_STORE_ID for key_id as it contains the actual Key ID (5XDRL75994)
  # APP_STORE_CONNECT_KEY_IDENTIFIER currently contains the private key content
  key_id = ENV.fetch("APP_STORE_ID")
  issuer_id = ENV.fetch("APP_STORE_CONNECT_ISSUER_ID")
  key_content_raw = ENV.fetch("APP_STORE_CONNECT_PRIVATE_KEY")
  key_content = normalize_private_key(key_content_raw)

  UI.message("üîê Using App Store Connect API key (ID: #{key_id}, Issuer: #{issuer_id.to_s[0, 8]}‚Ä¶)")
  UI.message("üîë Private key includes header? #{key_content&.include?('BEGIN PRIVATE KEY') ? 'yes' : 'no'}")

  app_store_connect_api_key(
    key_id: key_id,
    issuer_id: issuer_id,
    key: key_content,  # Correct parameter name for Fastlane
    duration: 1200,
    in_house: false
  )
end

platform :ios do
  lane :upload do
    UI.message("üöÄ Uploading TradeLine 24/7 build to TestFlight")

    api_key = tradeline_app_store_api_key

    # Get IPA_PATH from environment or file (Codemagic script steps are isolated)
    ipa_path = ENV["IPA_PATH"]&.strip
    ipa_path = "ipa/App.ipa" if ipa_path.nil? || ipa_path.empty?

    if ipa_path.nil? || ipa_path.empty? || !File.exist?(ipa_path)
      # Try reading from file written by build-ios.sh
      ipa_path_file = File.join(ENV["CM_BUILD_DIR"] || "build", "ipa_path.txt")
      if File.exist?(ipa_path_file)
        ipa_path = File.read(ipa_path_file).strip
        UI.message("üìñ Read IPA_PATH from file: #{ipa_path}")
      else
        # Fallback: find IPA in expected locations
        possible_paths = [
          File.join(ENV["CM_BUILD_DIR"] || "build", "ipa", "App.ipa"),
          "ios/build/export/*.ipa",
          "build/ipa/*.ipa"
        ]

        possible_paths.each do |pattern|
          found = Dir.glob(pattern).first
          if found && File.exist?(found)
            ipa_path = found
            UI.message("üîç Found IPA at: #{ipa_path}")
            break
          end
        end

        if ipa_path.nil? || ipa_path.empty?
          UI.user_error!("‚ùå IPA_PATH not found. Checked: #{possible_paths.join(', ')}")
        end
      end
    end

    UI.message("üì¶ IPA path: #{ipa_path}")
    UI.message("üì± Bundle ID: com.apex.tradeline")

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      app_identifier: "com.apex.tradeline",
      skip_submission: true,
      skip_waiting_for_build_processing: true
    )
  end
end
