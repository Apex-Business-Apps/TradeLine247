# fastlane/Fastfile
# Fastlane configuration for TradeLine 24/7 iOS TestFlight uploads
# This file handles uploading pre-built IPAs to TestFlight using App Store Connect API key authentication

default_platform(:ios)

def normalize_private_key(key_content)
  # If the env value contains literal \n sequences (single-line encoded key),
  # convert them back to real newlines. If the key already includes real newlines
  # and the -----BEGIN PRIVATE KEY----- header, leave it unchanged.
  if key_content.include?("\\n") && !key_content.include?("\n")
    key_content.gsub("\\n", "\n")
  else
    key_content
  end
end

def tradeline_app_store_api_key
  # Use APP_STORE_ID for key_id as it contains the actual Key ID (5XDRL75994)
  # APP_STORE_CONNECT_KEY_IDENTIFIER currently contains the private key content
  key_id = ENV.fetch("APP_STORE_ID")
  issuer_id = ENV.fetch("APP_STORE_CONNECT_ISSUER_ID")
  key_content_raw = ENV.fetch("APP_STORE_CONNECT_PRIVATE_KEY")
  key_content = normalize_private_key(key_content_raw)

  UI.message("ðŸ” Using App Store Connect API key (ID: #{key_id}, Issuer: #{issuer_id.to_s[0, 8]}â€¦)")
  UI.message("ðŸ”‘ Private key includes header? #{key_content&.include?('BEGIN PRIVATE KEY') ? 'yes' : 'no'}")

  app_store_connect_api_key(
    key_id: key_id,
    issuer_id: issuer_id,
    key_content: key_content,  # Fastlane expects 'key_content', not 'key'
    duration: 1200,
    in_house: false
  )
end

platform :ios do
  # Helper method to create App Store Connect API key from Codemagic environment variables
  # 
  # Reads the following environment variables (provided by Codemagic's appstore_credentials group):
  # - APP_STORE_CONNECT_KEY_IDENTIFIER: The API key ID (e.g., "5XDRL75994")
  # - APP_STORE_CONNECT_ISSUER_ID: The issuer UUID (e.g., "7efaf094-3c6f-4c6c-afdb-d6e2c84871c7")
  # - APP_STORE_CONNECT_PRIVATE_KEY: The full .p8 private key content (including BEGIN/END markers)
  #
  # Returns: An authenticated API key object for use with Fastlane actions
  def tradeline_api_key
    key_id    = ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"]
    issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]
    key_data  = ENV["APP_STORE_CONNECT_PRIVATE_KEY"]

    # Validate required environment variables are present
    UI.user_error!("Missing APP_STORE_CONNECT_KEY_IDENTIFIER") if key_id.to_s.strip.empty?
    UI.user_error!("Missing APP_STORE_CONNECT_ISSUER_ID")      if issuer_id.to_s.strip.empty?
    UI.user_error!("Missing APP_STORE_CONNECT_PRIVATE_KEY")    if key_data.to_s.strip.empty?

    # Validate private key format (should contain BEGIN/END markers)
    unless key_data.include?("BEGIN PRIVATE KEY") || key_data.include?("BEGIN RSA PRIVATE KEY")
      UI.user_error!("APP_STORE_CONNECT_PRIVATE_KEY appears invalid (missing BEGIN marker)")
    end

    # Log authentication method (with masked identifiers for security)
    UI.important("Using App Store Connect API key authentication")
    if ENV["BUNDLE_ID"]
      masked_bundle = ENV["BUNDLE_ID"].length > 14 ? 
        "#{ENV["BUNDLE_ID"][0..9]}*****#{ENV["BUNDLE_ID"][-4..-1]}" : 
        "*****"
      UI.important("Bundle ID: #{masked_bundle}")
    end
    if ENV["APP_STORE_ID"]
      masked_app_id = ENV["APP_STORE_ID"].length > 9 ? 
        "#{ENV["APP_STORE_ID"][0..4]}*****#{ENV["APP_STORE_ID"][-4..-1]}" : 
        "*****"
      UI.important("App Store ID: #{masked_app_id}")
    end

    # Create and return the API key object
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: key_data,
      duration: 1200 # 20 minutes - reasonable duration for upload operations
    )
  end

  desc "Upload pre-built IPA to TestFlight"
  desc "This lane assumes the IPA has already been built and signed by CI (Codemagic)"
  desc "It only handles the upload step using App Store Connect API key authentication"
  lane :upload do
    # Resolve IPA path with fallback logic
    ipa_path = ENV["IPA_PATH"]
    
    if ipa_path.to_s.strip.empty?
      # Fallback: Look for IPA in standard Codemagic export location
      export_dir = ENV["CM_BUILD_DIR"] ? "#{ENV['CM_BUILD_DIR']}/export" : "export"
      
      # Try multiple search patterns for robustness
      ipa_path = Dir["#{export_dir}/*.ipa"].first || 
                 Dir["#{export_dir}/**/*.ipa"].first || 
                 Dir["**/*.ipa"].first
    end
    
    # Validate IPA file exists and is readable
    unless ipa_path && File.exist?(ipa_path)
      UI.user_error!("IPA not found. Expected at $CM_BUILD_DIR/export/*.ipa or set IPA_PATH environment variable")
    end
    
    unless File.readable?(ipa_path)
      UI.user_error!("IPA file exists but is not readable: #{ipa_path}")
    end
    
    UI.success("Found IPA: #{ipa_path} (#{File.size(ipa_path) / 1024 / 1024} MB)")

    # Build API key object (validates credentials)
    api_key = tradeline_api_key

    # Upload to TestFlight
    UI.important("Uploading to TestFlight...")
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      app_identifier: ENV["BUNDLE_ID"],
      apple_id: ENV["APP_STORE_ID"],
      skip_waiting_for_build_processing: true # Don't wait for processing to complete
    )
    
    UI.success("âœ… Successfully uploaded to TestFlight!")
  end
end
