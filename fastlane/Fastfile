# fastlane/Fastfile
# =============================================================================
# TradeLine 24/7 - Fastlane Configuration for Codemagic CI
# =============================================================================
# This Fastfile provides deterministic TestFlight uploads using App Store
# Connect API credentials provided via Codemagic environment variables.
# =============================================================================

default_platform(:ios)

platform :ios do
  lane :upload do
    # Hardcoded ASC API credentials (verified working)
    api_key = app_store_connect_api_key(
      key_id: "5XDRL75994",
      issuer_id: "7efaf094-3c6f-4c6c-afdb-d6e2c84871c7",
      key_filepath: "/Users/builder/clone/AuthKey.p8",
      in_house: false
    )

    # Get IPA_PATH from environment or find it
    ipa_path = ENV["IPA_PATH"]
    if ipa_path.nil? || ipa_path.empty?
      # Fallback: find IPA in expected locations
      possible_paths = [
        "/Users/builder/clone/build/ios/ipa/*.ipa",
        "ios/build/export/*.ipa",
        "build/ipa/*.ipa"
      ]

      possible_paths.each do |pattern|
        found = Dir.glob(pattern).first
        if found && File.exist?(found)
          ipa_path = found
          UI.message("üîç Found IPA at: #{ipa_path}")
          break
        end
      end

      if ipa_path.nil? || ipa_path.empty?
        UI.user_error!("‚ùå IPA_PATH not found. Checked: #{possible_paths.join(', ')}")
      end
    end

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true
    )
  end
end
