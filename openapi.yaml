openapi: 3.0.0
info:
  title: [Your API Name]
  description: |
    [Your API description here]
    
    This API provides [key features and capabilities].
  version: 1.0.0
  contact:
    name: API Support
    email: support@yourdomain.com
  license:
    name: Proprietary

servers:
  - url: https://hysvqdwmhxnblxfqnszn.supabase.co/functions/v1
    description: Production server

tags:
  - name: Chat
    description: AI chat completion endpoints
  - name: RAG
    description: Retrieval-Augmented Generation endpoints
  - name: Dashboard
    description: Dashboard and analytics endpoints
  - name: Leads
    description: Lead submission endpoints

paths:
  /chat:
    post:
      tags:
        - Chat
      summary: AI Chat Completion
      description: Stream AI chat responses using Gemini model
      operationId: chat
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messages
              properties:
                messages:
                  type: array
                  maxItems: 100
                  items:
                    type: object
                    required:
                      - role
                      - content
                    properties:
                      role:
                        type: string
                        enum: [system, user, assistant]
                      content:
                        type: string
                        maxLength: 10000
            examples:
              basic:
                value:
                  messages:
                    - role: user
                      content: Hello, how can you help me?
      responses:
        '200':
          description: Streaming response
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /rag-search:
    post:
      tags:
        - RAG
      summary: RAG Search
      description: Search using Retrieval-Augmented Generation with filters
      operationId: ragSearch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query_text:
                  type: string
                  description: Search query text
                top_k:
                  type: integer
                  minimum: 1
                  maximum: 100
                  default: 5
                  description: Number of results to return
                filters:
                  type: object
                  description: Optional filters for search
                  properties:
                    source_type:
                      type: string
                    lang:
                      type: string
                queryLang:
                  type: string
                  description: Language hint for query
                autoLang:
                  type: boolean
                  description: Automatically detect language
            examples:
              basic:
                value:
                  query_text: How do I schedule an appointment?
                  top_k: 5
      responses:
        '200':
          description: Successful search
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RagSearchResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded (60 requests/minute)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /rag-answer:
    post:
      tags:
        - RAG
      summary: RAG Answer Synthesis
      description: Generate answers from retrieved context using RAG
      operationId: ragAnswer
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
              properties:
                question:
                  type: string
                  description: Question to answer
                context:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                      text:
                        type: string
                      score:
                        type: number
                      metadata:
                        type: object
                filters:
                  type: object
                lang:
                  type: string
                  description: Language hint
                model:
                  type: string
                  description: Model to use (e.g., gpt-4o-mini)
                temperature:
                  type: number
                  minimum: 0
                  maximum: 2
                maxTokens:
                  type: integer
            examples:
              basic:
                value:
                  question: What is your return policy?
                  context:
                    - text: Our return policy allows returns within 30 days...
      responses:
        '200':
          description: Successful answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RagAnswerResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded (30 requests/minute)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dashboard-summary:
    get:
      tags:
        - Dashboard
      summary: Get Dashboard Summary
      description: Retrieve dashboard summary data including KPIs, next items, and transcripts
      operationId: getDashboardSummary
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardSummary'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /secure-lead-submission:
    post:
      tags:
        - Leads
      summary: Submit Lead
      description: Submit a new lead (public endpoint, no authentication required)
      operationId: submitLead
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - company
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                email:
                  type: string
                  format: email
                company:
                  type: string
                  minLength: 1
                  maxLength: 200
                notes:
                  type: string
                  maxLength: 1000
                phone:
                  type: string
            examples:
              basic:
                value:
                  name: John Doe
                  email: john@example.com
                  company: Acme Corp
                  notes: Interested in AI receptionist services
      responses:
        '200':
          description: Lead submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  id:
                    type: string
                    format: uuid
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication. Include the token in the Authorization header:
        Authorization: Bearer YOUR_TOKEN

  schemas:
    Error:
      type: object
      required:
        - ok
        - error
      properties:
        ok:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
        message:
          type: string
          description: Additional error details

    RateLimitError:
      allOf:
        - $ref: '#/components/schemas/Error'
        - type: object
          properties:
            remaining:
              type: integer
              description: Number of requests remaining
              example: 0

    RagSearchResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          example: true
        filters:
          type: object
        results:
          type: array
          items:
            type: object
        remaining:
          type: integer
          description: Number of requests remaining in rate limit window

    RagAnswerResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          example: true
        answer:
          type: string
          description: Generated answer
        citations:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              snippet:
                type: string
        meta:
          type: object
          properties:
            context_items:
              type: integer
            lang:
              type: string
            model:
              type: string
        remaining:
          type: integer
          description: Number of requests remaining in rate limit window

    DashboardSummary:
      type: object
      properties:
        kpis:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                enum: [bookings, payout, answerRate, rescued]
              value:
                type: number
              deltaPct:
                type: number
              currency:
                type: string
        nextItems:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              whenISO:
                type: string
                format: date-time
              name:
                type: string
              contact:
                type: string
              status:
                type: string
                enum: [new, confirmed, reschedule]
              actions:
                type: array
                items:
                  type: string
                  enum: [confirm, reschedule, note]
        transcripts:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              atISO:
                type: string
                format: date-time
              caller:
                type: string
              summary:
                type: string
              sentiment:
                type: string
                enum: [positive, neutral, negative]
              needsReply:
                type: boolean
        lastUpdated:
          type: string
          format: date-time








