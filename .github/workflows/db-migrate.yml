name: db/migrate
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - supabase/migrations/**
  pull_request:
    branches: [main]
    paths:
      - supabase/migrations/**

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

    steps:
      - uses: actions/checkout@v3
      
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: üêò Run Database Migrations (Direct Connection)
        shell: bash
        run: |
          # 1. Safely encode the password for the URL
          # This handles special characters in your secret
          ENCODED_PASSWORD=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote_plus(os.environ['SUPABASE_DB_PASSWORD']))")
          
          # 2. Construct the Direct Connection String
          # Standard Supabase format: postgres://postgres:[password]@db.[ref].supabase.co:5432/postgres
          DB_URL="postgresql://postgres:${ENCODED_PASSWORD}@db.${SUPABASE_PROJECT_ID}.supabase.co:5432/postgres"
          
          echo "üöÄ Starting Stateless Migration..."
          
          # 3. Execute Push Bypass (No Link Required)
          # We use --db-url to talk directly to the remote DB
          supabase db push --include-all --db-url "$DB_URL"
