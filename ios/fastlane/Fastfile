platform :ios do
  lane :upload do
    key_id = ENV['APP_STORE_CONNECT_KEY_IDENTIFIER']
    issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
    private_key = ENV['APP_STORE_CONNECT_PRIVATE_KEY']

    if key_id.to_s.empty? || issuer_id.to_s.empty? || private_key.to_s.empty?
      UI.user_error!("Missing App Store Connect API key env vars.")
    end

    is_base64 = !private_key.include?("BEGIN") && !private_key.include?("END")

    UI.message("üîê Configuring App Store Connect API key...")
    UI.message("   Key ID: #{key_id}")
    UI.message("   Issuer: #{issuer_id}")
    UI.message("   Private key appears base64? #{is_base64 ? 'yes' : 'no'}")

    api_key = app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: private_key,
      is_key_content_base64: is_base64,
      duration: 1200,
      in_house: false,
      set_spaceship_token: true
    )

    # Resolve IPA path
    ipa_path = ENV['IPA_PATH']

    if ipa_path.to_s.strip.empty?
      ipa_path_file = File.join('ios', 'build', 'export', 'ipa_path.txt')
      if File.exist?(ipa_path_file)
        ipa_path = File.read(ipa_path_file).strip
      end
    end

    if ipa_path.to_s.strip.empty? || !File.exist?(ipa_path)
      UI.user_error!("IPA not found. Expected IPA_PATH env var or ios/build/export/ipa_path.txt pointing to an existing .ipa")
    end

    UI.message("üöÄ Uploading IPA to TestFlight: #{ipa_path}")

    upload_to_testflight(
      app_identifier: ENV['BUNDLE_ID'] || 'com.apex.tradeline',
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      api_key: api_key
    )
  end
end
