# frozen_string_literal: true

platform :ios do
  desc "Upload IPA to TestFlight using App Store Connect API key"
  lane :upload do
    def fetch_env!(key)
      value = ENV[key]&.strip
      UI.user_error!("❌ Missing required env var #{key}") if value.nil? || value.empty?
      value
    end

    key_id = fetch_env!("APP_STORE_CONNECT_KEY_IDENTIFIER")
    issuer_id = fetch_env!("APP_STORE_CONNECT_ISSUER_ID")
    key_content_raw = fetch_env!("APP_STORE_CONNECT_PRIVATE_KEY")

    key_content = key_content_raw.include?("\\n") ? key_content_raw.gsub("\\n", "\n") : key_content_raw
    is_base64 = key_content.strip.start_with?("LS0t") && !key_content.include?("BEGIN PRIVATE KEY")

    api_key = app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: key_content,
      is_key_content_base64: is_base64,
      duration: 1200,
      in_house: false
    )

    ios_root = File.expand_path("..", __dir__)
    ipa_env = ENV["IPA_PATH"]&.strip
    ipa_from_env = if ipa_env && !ipa_env.empty?
      File.expand_path(ipa_env, ios_root)
    end

    ipa_path = nil

    if ipa_from_env && File.exist?(ipa_from_env)
      ipa_path = ipa_from_env
    else
      exported_ipas = Dir.glob(File.join(ios_root, "build", "export", "*.ipa"))
      ipa_path = exported_ipas.max_by { |path| File.mtime(path) } if exported_ipas.any?
    end

    UI.user_error!("❌ IPA not found in ios/build/export") if ipa_path.nil? || ipa_path.empty? || !File.exist?(ipa_path)

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_submission: true,
      skip_waiting_for_build_processing: true
    )
  end
end
