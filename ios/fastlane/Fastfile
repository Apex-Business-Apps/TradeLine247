platform :ios do
  desc "Upload TradeLine 24/7 build to TestFlight"
  lane :upload do
    # Get API credentials
    key_id    = ENV['APP_STORE_CONNECT_KEY_IDENTIFIER']
    issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
    private_key   = ENV['APP_STORE_CONNECT_PRIVATE_KEY']

    if [key_id, issuer_id, private_key].any?(&:nil?)
      UI.user_error!('Missing App Store Connect API credentials')
    end

    # Configure API key
    is_base64 = !private_key.include?('BEGIN PRIVATE KEY')
    api_key = app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: private_key,
      is_key_content_base64: is_base64
    )

    # Find IPA
    ipa_path = ENV['IPA_PATH']

    if ipa_path.nil? || ipa_path.empty?
      ipa_file = 'ios/build/export/ipa_path.txt'
      ipa_path = File.read(ipa_file).strip if File.exist?(ipa_file)
    end

    if ipa_path.nil? || ipa_path.empty? || !File.exist?(ipa_path)
      UI.user_error!("Could not locate IPA to upload. Searched IPA_PATH and ios/build/export/*.ipa")
    end

    # Upload to TestFlight
    upload_to_testflight(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      api_key: api_key
    )
  end
end
