import{j as e}from"./react-query-DHkNQnk-.js";import{r as s}from"./react-vendor-a1y4eqJD.js";import{z as l,J as a,T as t,K as i,C as n,d,f as c,h as r,j as o,B as m,g as x}from"./index-Dpo-kh1j.js";import{C as h}from"./circle-check-BQj80rBD.js";import{E as u}from"./external-link-h-dUz94N.js";import{C as j}from"./circle-x-CEMfQcIp.js";import"./radix-primitives-BmowSk35.js";import"./radix-overlays-COL35z5_.js";import"./supabase-Ccy6tpTo.js";import"./react-router-DP697y4K.js";import"./radix-forms-DXrNnkJS.js";function v(){const[v,f]=s.useState(null),[p,b]=s.useState(!0);s.useEffect(()=>{N();const e=setInterval(N,3e4);return()=>clearInterval(e)},[]);const N=async()=>{try{const e=new Date(Date.now()-864e5).toISOString(),{data:s}=await l.from("call_logs").select("status, captured_fields").gte("created_at",e),a=(null==s?void 0:s.filter(e=>"completed"===e.status).length)||0,t=(null==s?void 0:s.filter(e=>"failed"===e.status).length)||0,i=(null==s?void 0:s.filter(e=>{var s;return!0===(null==(s=e.captured_fields)?void 0:s.stream_fallback)}).length)||0,{data:n}=await l.from("voice_stream_logs").select("elapsed_ms").eq("fell_back",!1).gte("created_at",e),d=(n||[]).map(e=>e.elapsed_ms).filter(Boolean).sort((e,s)=>e-s),c=d.length>0?Math.round(d.reduce((e,s)=>e+s,0)/d.length):0,r=d[Math.floor(.95*d.length)]||0,{data:o}=await l.from("sms_reply_logs").select("message_sid").gte("created_at",e),{data:m}=await l.from("sms_status_logs").select("status").gte("created_at",e),x=(null==m?void 0:m.filter(e=>"delivered"===e.status).length)||0,h=(null==m?void 0:m.length)||1,u=Math.round(x/h*100),{data:j}=await l.from("twilio_buy_number_logs").select("*").eq("success",!0).gte("created_at",e);f({voice:{answeredCount:a,failedCount:t,streamFallbackCount:i,avgHandshakeMs:c,p95HandshakeMs:r},sms:{inboundCount:(null==o?void 0:o.length)||0,deliverySuccessRate:u},numbers:{purchasedCount:(null==j?void 0:j.length)||0}})}catch(e){console.error("Error loading metrics:",e)}finally{b(!1)}};if(p)return e.jsx("div",{className:"p-8",children:"Loading health metrics..."});const w=(null==v?void 0:v.voice.p95HandshakeMs)<1500,g=(null==v?void 0:v.sms.deliverySuccessRate)>=95,y=(null==v?void 0:v.voice.p95HandshakeMs)>1500&&(null==v?void 0:v.voice.p95HandshakeMs)<=2e3,k=(null==v?void 0:v.voice.p95HandshakeMs)>2e3,_=(null==v?void 0:v.voice.streamFallbackCount)/((null==v?void 0:v.voice.answeredCount)||1)>.05&&(null==v?void 0:v.voice.streamFallbackCount)/((null==v?void 0:v.voice.answeredCount)||1)<=.1,C=(null==v?void 0:v.voice.streamFallbackCount)/((null==v?void 0:v.voice.answeredCount)||1)>.1;return e.jsxs("div",{className:"container mx-auto py-8 space-y-6",children:[(k||C)&&e.jsxs(a,{variant:"destructive",children:[e.jsx(t,{className:"h-4 w-4"}),e.jsxs(i,{children:[e.jsx("div",{className:"font-semibold",children:"CRITICAL: Performance threshold exceeded"}),k&&e.jsx("div",{children:"â€¢ P95 handshake > 2000ms for 15m"}),C&&e.jsx("div",{children:"â€¢ Stream fallbacks > 10% over 1h"})]})]}),(y||_)&&!k&&!C&&e.jsxs(a,{children:[e.jsx(t,{className:"h-4 w-4"}),e.jsxs(i,{children:[e.jsx("div",{className:"font-semibold",children:"WARNING: Performance degradation detected"}),y&&e.jsx("div",{children:"â€¢ P95 handshake > 1500ms for 15m"}),_&&e.jsx("div",{children:"â€¢ Stream fallbacks > 5% over 1h"})]})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Twilio Integration Evidence"}),e.jsx("p",{className:"text-muted-foreground",children:"PROMPT F: Health metrics and compliance proofs (24h)"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-4",children:[e.jsxs(n,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(c,{className:"text-sm font-medium",children:"Inbound Calls"}),w?e.jsx(h,{className:"h-5 w-5 text-[hsl(142,85%,25%)]"}):e.jsx(t,{className:"h-5 w-5 text-amber-700"})]}),e.jsxs(r,{className:"space-y-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:null==v?void 0:v.voice.answeredCount}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Answered:"}),e.jsx("span",{className:"font-mono",children:null==v?void 0:v.voice.answeredCount})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Failed:"}),e.jsx("span",{className:"font-mono text-red-700",children:null==v?void 0:v.voice.failedCount})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Stream Fallback:"}),e.jsx("span",{className:"font-mono text-amber-800",children:null==v?void 0:v.voice.streamFallbackCount})]})]}),e.jsxs(o,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>window.open("https://supabase.com/dashboard/project/hysvqdwmhxnblxfqnszn/editor/28892","_blank"),children:["View Logs ",e.jsx(u,{className:"ml-2 h-3 w-3"})]})]})]}),e.jsxs(n,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(c,{className:"text-sm font-medium",children:"Voice Stream"}),e.jsxs(m,{variant:k?"destructive":y?"secondary":"default",children:["P95: ",k?"RED":y?"YELLOW":"GREEN"]})]}),e.jsxs(r,{className:"space-y-2",children:[e.jsxs("div",{className:"text-2xl font-bold",children:[null==v?void 0:v.voice.avgHandshakeMs,"ms"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Avg Handshake"}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"P95:"}),e.jsxs(m,{variant:k?"destructive":y?"secondary":"default",children:[null==v?void 0:v.voice.p95HandshakeMs,"ms"]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:[e.jsx("div",{children:"ðŸŸ¢ Target: <1500ms"}),e.jsx("div",{children:"ðŸŸ¡ Warning: >1500ms"}),e.jsx("div",{children:"ðŸ”´ Critical: >2000ms"})]}),e.jsxs(o,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>window.open("https://supabase.com/dashboard/project/hysvqdwmhxnblxfqnszn/editor/28893","_blank"),children:["Stream Logs ",e.jsx(u,{className:"ml-2 h-3 w-3"})]})]})]}),e.jsxs(n,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(c,{className:"text-sm font-medium",children:"SMS"}),g?e.jsx(h,{className:"h-5 w-5 text-[hsl(142,85%,25%)]"}):e.jsx(j,{className:"h-5 w-5 text-red-700"})]}),e.jsxs(r,{className:"space-y-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:null==v?void 0:v.sms.inboundCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Inbound Messages"}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Delivery Rate:"}),e.jsxs(m,{variant:(null==v?void 0:v.sms.deliverySuccessRate)>=95?"default":"destructive",children:[null==v?void 0:v.sms.deliverySuccessRate,"%"]})]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(o,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>window.open("https://supabase.com/dashboard/project/hysvqdwmhxnblxfqnszn/editor/28894","_blank"),children:"Reply Logs"}),e.jsx(o,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>window.open("https://supabase.com/dashboard/project/hysvqdwmhxnblxfqnszn/editor/28895","_blank"),children:"Status Logs"})]})]})]}),e.jsxs(n,{children:[e.jsx(d,{className:"flex flex-row items-center justify-between pb-2",children:e.jsx(c,{className:"text-sm font-medium",children:"Numbers"})}),e.jsxs(r,{className:"space-y-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:null==v?void 0:v.numbers.purchasedCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Purchased (24h)"}),e.jsxs(o,{variant:"outline",size:"sm",className:"w-full mt-4",onClick:()=>window.open("https://supabase.com/dashboard/project/hysvqdwmhxnblxfqnszn/editor/28897","_blank"),children:["Purchase Logs ",e.jsx(u,{className:"ml-2 h-3 w-3"})]})]})]})]}),e.jsxs(n,{children:[e.jsxs(d,{children:[e.jsx(c,{children:"PROMPT I: Operator Smoke Tests"}),e.jsx(x,{children:"Evidence you can screenshot"})]}),e.jsxs(r,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"âœ… Test 1: Call the newly bought number"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"Hear consent voice, bridge target, call completes"}),e.jsx("li",{children:"Evidence: one call_logs row; if stream fallback triggered, stream_fallback=true"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"âœ… Test 2: Send inbound SMS"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"Receive template reply"}),e.jsx("li",{children:"Evidence: one sms_reply_logs row (source=twilio, external_id=MessageSid)"}),e.jsx("li",{children:'Evidence: one sms_status_logs row with "delivered"'})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"âœ… Test 3: Console spot-check"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"Number shows VoiceUrl: /functions/v1/voice-answer"}),e.jsx("li",{children:"Number shows SmsUrl: /functions/v1/webcomms-sms-reply"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"âœ… Test 4: Evidence dashboard"}),e.jsx("ul",{className:"list-disc list-inside text-sm text-muted-foreground",children:e.jsx("li",{children:"All four tiles reflect increments within 60s"})})]}),e.jsxs(a,{className:"mt-4",children:[e.jsx(h,{className:"h-4 w-4"}),e.jsx(i,{children:e.jsx("div",{className:"font-semibold",children:"Acceptance: All four pass without manual DB edits"})})]})]})]})]})}export{v as default};
