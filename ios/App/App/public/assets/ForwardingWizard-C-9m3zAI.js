import{j as e}from"./react-query-DHkNQnk-.js";import{r as a}from"./react-vendor-a1y4eqJD.js";import{a5 as r,E as t,z as i,a6 as n,a7 as s}from"./index-Dpo-kh1j.js";import"./radix-primitives-BmowSk35.js";import"./radix-overlays-COL35z5_.js";import"./supabase-Ccy6tpTo.js";import"./react-router-DP697y4K.js";import"./radix-forms-DXrNnkJS.js";const l=r.voiceNumber,o=n.supabaseFunctionsUrl;function d(){const[r,n]=a.useState("+1"),[s,d]=a.useState(""),[u,f]=a.useState("ROGERS_FIDO"),[m,p]=a.useState("idle"),[v,x]=a.useState("Ready to verify."),[h,b]=a.useState(null),g=a.useMemo(()=>{switch(u){case"ROGERS_FIDO":case"TELUS_KOODO":return{activateHref:`tel:*21*${l}#`,deactivateHref:"tel:##21#",instructions:"Tap from the device owning the number (GSM *21* / ##21#)."};case"BELL_MOBILITY":return{instructions:`Open Phone → Settings → Call Forwarding → Always forward → set ${l}.`};default:return{instructions:`From handset: Dial *72, then ${l}. If busy/no answer, repeat once. Disable with *73.`}}},[u]);return a.useEffect(()=>{if(!h||"pending"!==m)return;if(!t)return void x("Supabase disabled in this environment. Verify manually via inbound call logs.");let e=!1;const a=setInterval(async()=>{const{data:r,error:t}=await i.from("forwarding_checks").select("status, notes").eq("id",h).maybeSingle();if(e)return;if(t)return console.error("Forwarding status poll failed",t),void x(t.message??"Unable to poll verification status.");if(!r)return;p(r.status);const n=r.notes?` — ${r.notes}`:"";"verified"===r.status?(x(`Verified via inbound forwarding${n}`),clearInterval(a)):"failed"===r.status?(x(`Verification failed${n}`),clearInterval(a)):x(`Awaiting forwarded inbound${n}`)},4e3);return()=>{e=!0,clearInterval(a)}},[h,m]),e.jsxs("div",{className:"p-6 max-w-3xl mx-auto space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Forwarding Wizard"}),e.jsx("div",{className:"space-x-2",children:["ROGERS_FIDO","TELUS_KOODO","BELL_MOBILITY","LANDLINE"].map(a=>e.jsx("button",{onClick:()=>f(a),className:"px-3 py-2 rounded-xl border "+(u===a?"bg-black text-white":"bg-white"),children:a.replace("_","/")},a))}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm",children:"Client’s current (old) number (E.164):"}),e.jsx("input",{className:"border rounded-xl px-3 py-2",value:r,onChange:e=>n(e.target.value),placeholder:"+1XXXXXXXXXX"}),e.jsx("label",{className:"text-sm",children:"Org Id (UUID):"}),e.jsx("input",{className:"border rounded-xl px-3 py-2",value:s,onChange:e=>d(e.target.value),placeholder:"UUID"})]}),e.jsxs("div",{className:"rounded-2xl border p-4 space-y-3",children:[e.jsx("h2",{className:"font-semibold",children:"Activate forwarding"}),e.jsx("p",{className:"text-sm",children:g.instructions}),e.jsxs("div",{className:"flex gap-3",children:["activateHref"in g&&g.activateHref?e.jsx("a",{className:"px-4 py-2 rounded-xl border",href:g.activateHref,children:"Activate"}):null,"deactivateHref"in g&&g.deactivateHref?e.jsx("a",{className:"px-4 py-2 rounded-xl border",href:g.deactivateHref,children:"Deactivate"}):null]})]}),e.jsxs("div",{className:"rounded-2xl border p-4 space-y-3",children:[e.jsx("h2",{className:"font-semibold",children:"Auto-verification"}),e.jsx("button",{onClick:async function(){var e;if(!o)return p("failed"),void x("Missing FUNCTIONS_BASE configuration");const a=s||"00000000-0000-0000-0000-000000000000";p("pending"),x("Placing a short test call to the old number; awaiting forwarded inbound…");try{const t=await fetch(`${o}/forwarding-verify-start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({org_id:a,old_number_e164:r})}),i=await t.json().catch(()=>({}));if(!t.ok){p("failed");const a=(null==(e=null==i?void 0:i.error)?void 0:e.message)??(null==i?void 0:i.error)??"Verification start failed";return void x("string"==typeof a?a:"Verification start failed")}b((null==i?void 0:i.check_id)??null),p((null==i?void 0:i.status)||"pending"),x("Verification pending (~20s). When forwarding is active, inbound will mark Verified.")}catch(t){console.error("Verification start failed",t),p("failed"),x(t instanceof Error?t.message:"Verification start failed")}},className:"px-4 py-2 rounded-xl border",children:"Place test call & verify"}),e.jsxs("div",{className:"text-sm",children:["Status: ",e.jsx("b",{children:m})," — ",v]})]}),e.jsx(c,{})]})}function c(){const[r,t]=a.useState("+1"),[i,n]=a.useState(""),[l,o]=a.useState("Twilio will place a quick call to confirm ownership.");return e.jsxs("div",{className:"rounded-2xl border p-4 space-y-2",children:[e.jsx("h2",{className:"font-semibold",children:"Outbound Caller ID (show legacy number)"}),e.jsx("input",{className:"border rounded-xl px-3 py-2 w-full",value:r,onChange:e=>t(e.target.value),placeholder:"+1XXXXXXXXXX"}),e.jsx("input",{className:"border rounded-xl px-3 py-2 w-full",value:i,onChange:e=>n(e.target.value),placeholder:"Label (optional)"}),e.jsx("button",{onClick:async function(){var e,a;try{const t=await fetch(s.callerIdVerifyStart,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone_number_e164:r,friendly_name:i})}),n=await t.json();if(!t.ok)return void o("Error: "+((null==(e=null==n?void 0:n.error)?void 0:e.message)??(null==n?void 0:n.error)??"unknown"));const l=null==(a=null==n?void 0:n.data)?void 0:a.validation_code;o(`Twilio will call ${r}. Enter code ${l} to complete verification.`)}catch(t){console.error("Caller ID verification failed",t),o("Error: "+(t instanceof Error?t.message:"unknown"))}},className:"px-4 py-2 rounded-xl border",children:"Verify caller ID"}),e.jsx("div",{className:"text-sm",children:l})]})}export{d as default};
